<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Demo Ransomware Datos Reales</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  #map { height: 100vh; width: 100vw; }
  .legend {
    position: absolute;
    bottom: 30px; left: 20px;
    background: white; padding: 6px 8px;
    font-size: 14px; color: #555;
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
    border-radius: 5px; line-height: 18px;
    z-index: 1000;
  }
  .legend i {
    width: 24px; height: 18px; float: left; margin-right: 8px; opacity: 0.9;
    border-radius: 5px;
    border: 1px solid #ddd;
  }
</style>
</head>
<body>

<div id="map"></div>
<div class="legend">
  <i style="background: #FFEDA0"></i> Bajo<br>
  <i style="background: #FC4E2A"></i> Medio<br>
  <i style="background: #800026"></i> Muy alto<br>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// Devuelve color en degradado (de amarillo a rojo oscuro) según valor [0-1]
function lerpColor(a, b, t) {
  // a y b: colores hex, t: 0-1
  let ah = parseInt(a.replace('#',''),16),
      bh = parseInt(b.replace('#',''),16),
      ar = (ah>>16)&0xff, ag = (ah>>8)&0xff, ab = ah&0xff,
      br = (bh>>16)&0xff, bg = (bh>>8)&0xff, bb = bh&0xff,
      rr = ar + t*(br-ar),
      rg = ag + t*(bg-ag),
      rb = ab + t*(bb-ab);
  return '#' + (((1<<24)+(rr<<16)+(rg<<8)+(rb|0)).toString(16).slice(1,7));
}

// De amarillo (bajo) a rojo fuerte (muy alto)
function getColorGradient(d, max) {
  if (!d || d === 0) return null;
  const t = Math.min(1, d / max);
  // Puedes ajustar los colores aquí: de amarillo claro a rojo oscuro
  // Más suave: ['#FFEDA0', '#FC4E2A', '#800026']
  if (t < 0.5) {
    // De amarillo a naranja
    return lerpColor('#FFEDA0', '#FC4E2A', t*2);
  } else {
    // De naranja a rojo fuerte
    return lerpColor('#FC4E2A', '#800026', (t-0.5)*2);
  }
}

const map = L.map('map').setView([20, 0], 2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 5,
  attribution: '© OpenStreetMap'
}).addTo(map);

const proxyUrl = '/.netlify/functions/ransomware';
const geoJsonUrl = 'countries.geojson';

Promise.all([
  fetch(proxyUrl).then(res => res.json()),
  fetch(geoJsonUrl).then(res => res.json())
]).then(([ataques, geojson]) => {
  let ataquesArray = Array.isArray(ataques) ? ataques : (ataques.data || []);
  const ataquesPorPais = ataquesArray.reduce((acc, cur) => {
    const c = (cur.country || '').toUpperCase();
    if (c) acc[c] = (acc[c] || 0) + 1;
    return acc;
  }, {});
  const maxAtaques = Math.max(...Object.values(ataquesPorPais), 1);

  L.geoJSON(geojson, {
    style: feature => {
      const iso = (feature.properties["ISO3166-1-Alpha-2"] || "").toUpperCase();
      const count = ataquesPorPais[iso] || 0;
      const fillColor = getColorGradient(count, maxAtaques);
      if (!fillColor) return { fillOpacity: 0, weight: 1, color: '#222' };
      return {
        fillColor,
        weight: 1.7,
        color: '#333',
        fillOpacity: 0.93,
        opacity: 0.97
      };
    },
    onEachFeature: (feature, layer) => {
      const iso = (feature.properties["ISO3166-1-Alpha-2"] || "").toUpperCase();
      const count = ataquesPorPais[iso] || 0;
      if (count > 0) {
        layer.bindTooltip(`${feature.properties.ADMIN}: ${count} ataques`);
      }
    }
  }).addTo(map);
}).catch(err => {
  console.error('Error al cargar datos:', err);
});
</script>

</body>
</html>
