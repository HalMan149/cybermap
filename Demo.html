<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Demo Mapa Ransomware Real</title>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<style>
  body, html {
    margin:0; padding:0; height:100%; width:100%; background:#fff;
  }
  #map {
    height: 100vh;
    width: 100vw;
  }
  .legend {
    position: absolute;
    bottom: 30px;
    left: 20px;
    background: white;
    padding: 6px 10px;
    font-family: Arial, sans-serif;
    font-size: 14px;
    border-radius: 4px;
    box-shadow: 0 0 6px rgba(0,0,0,0.3);
  }
  .legend span {
    display: inline-block;
    width: 30px;
    height: 14px;
  }
</style>
</head>
<body>
<div id="map"></div>
<div class="legend">
  <span style="background: #ffffb2"></span> Pocos &nbsp;
  <span style="background: #fecc5c"></span> Medio &nbsp;
  <span style="background: #fd8d3c"></span> Alto &nbsp;
  <span style="background: #f03b20"></span> Muy alto
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  // Crear mapa
  const map = L.map("map").setView([20, 0], 2);

  // Añadir mapa base
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 6,
    attribution: "© OpenStreetMap"
  }).addTo(map);

  // Cargar geojson de países
  fetch("countries.geojson")
    .then(r => r.json())
    .then(geojson => {
      console.log("GeoJSON cargado:", geojson);

      // Cargar datos ataques
      fetch("datos_ataques.json")
        .then(r => r.json())
        .then(ataques => {
          console.log("Ataques cargados:", ataques);

          // Contar ataques por país (ISO2 en mayúsculas)
          const conteo = {};
          ataques.forEach(a => {
            const c = a.country?.toUpperCase();
            if(c) conteo[c] = (conteo[c]||0) + 1;
          });
          console.log("Conteo ataques por país:", conteo);

          // Función para color según cantidad ataques
          function getColor(d) {
            return d > 10 ? '#f03b20' :
                   d > 5  ? '#fd8d3c' :
                   d > 2  ? '#fecc5c' :
                            '#ffffb2';
          }

          // Estilo para cada país
          function style(feature) {
            const c = feature.properties.ISO_A2 || feature.properties.ISO3166_1_Alpha_2;
            const ataques = conteo[c] || 0;
            return {
              fillColor: getColor(ataques),
              weight: 1,
              opacity: 1,
              color: 'gray',
              fillOpacity: 0.8
            };
          }

          // Mostrar tooltip con info
          function onEachFeature(feature, layer) {
            const c = feature.properties.ISO_A2 || feature.properties.ISO3166_1_Alpha_2;
            const ataques = conteo[c] || 0;
            const name = feature.properties.ADMIN || feature.properties.name || "Desconocido";
            layer.bindTooltip(`${name}: ${ataques} ataques`, {sticky:true});
          }

          // Añadir capa GeoJSON con estilo y tooltip
          L.geoJSON(geojson, {
            style: style,
            onEachFeature: onEachFeature
          }).addTo(map);
        });
    })
    .catch(e => {
      console.error("Error cargando archivos:", e);
      alert("Error cargando datos o geojson, revisa consola.");
    });
</script>
</body>
</html>
