<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Demo Ransomware Datos Reales</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  #map { height: 100vh; width: 100vw; }
</style>
</head>
<body>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// Color base: rojo claro -> rojo oscuro
const rojoClaro = [255, 90, 90];   // Rojo claro (RGB)
const rojoOscuro = [120, 0, 0];    // Rojo oscuro (RGB)

// CORREGIDO: Más ataques = MÁS opaco y MÁS oscuro
function colorYOpacidad(count, max) {
  if (!count || count === 0) return { fillOpacity: 0, fillColor: null };
  const t = Math.min(1, count / max);

  // Color: de claro (pocos ataques) a oscuro (muchos ataques)
  const r = Math.round(rojoClaro[0] + (rojoOscuro[0] - rojoClaro[0]) * t);
  const g = Math.round(rojoClaro[1] + (rojoOscuro[1] - rojoClaro[1]) * t);
  const b = Math.round(rojoClaro[2] + (rojoOscuro[2] - rojoClaro[2]) * t);
  const fillColor = `rgb(${r},${g},${b})`;

  // CORREGIDO: Opacidad va de 0.34 (pocos) a 0.84 (muchos)
  const fillOpacity = 0.34 + 0.5 * t;

  return { fillColor, fillOpacity };
}

const map = L.map('map').setView([20, 0], 2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 5,
  attribution: '© OpenStreetMap'
}).addTo(map);

const proxyUrl = '/.netlify/functions/ransomware';
const geoJsonUrl = 'countries.geojson';

Promise.all([
  fetch(proxyUrl).then(res => res.json()),
  fetch(geoJsonUrl).then(res => res.json())
]).then(([ataques, geojson]) => {
  let ataquesArray = Array.isArray(ataques) ? ataques : (ataques.data || []);
  const ataquesPorPais = ataquesArray.reduce((acc, cur) => {
    const c = (cur.country || '').toUpperCase();
    if (c) acc[c] = (acc[c] || 0) + 1;
    return acc;
  }, {});
  const maxAtaques = Math.max(...Object.values(ataquesPorPais), 1);

  L.geoJSON(geojson, {
    style: feature => {
      const iso = (feature.properties["ISO3166-1-Alpha-2"] || "").toUpperCase();
      const count = ataquesPorPais[iso] || 0;
      const { fillColor, fillOpacity } = colorYOpacidad(count, maxAtaques);
      if (!fillColor) return { fillOpacity: 0, color: '#222', weight: 1 };
      return {
        fillColor,
        fillOpacity,
        weight: 1.6,
        color: '#333',
        opacity: 0.97
      };
    },
    onEachFeature: (feature, layer) => {
      const iso = (feature.properties["ISO3166-1-Alpha-2"] || "").toUpperCase();
      const count = ataquesPorPais[iso] || 0;
      if (count > 0) {
        layer.bindTooltip(`${feature.properties.ADMIN}: ${count} ataques`);
      }
    }
  }).addTo(map);
}).catch(err => {
  console.error('Error al cargar datos:', err);
});
</script>

</body>
</html>
