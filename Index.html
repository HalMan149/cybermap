<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Mapa Cyberpunk + Noticias Ciberseguridad</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body {
      height: 100vh; width: 100vw; margin: 0; padding: 0; background: #0b1021;
      box-sizing: border-box;
    }
    #map {
      width: 100vw; height: 100vh; margin: 0; padding: 0; background: #0b1021;
      box-sizing: border-box;
    }
    .zona-horaria-label, .city-clock-label { pointer-events: none; user-select: none; }
    .gmt-utc-clock {
      font-family: 'Consolas', monospace; font-size: 1.25em;
      padding: 2px 12px; border-radius: 12px; border: 2.2px solid #00ffd9a0;
      background: #0a233bf2; color: #1fffb7; font-weight: 600;
      margin-top: 6px; margin-bottom: 0; text-align: center; width: 76px;
      box-shadow: 0 0 8px #0ff8; letter-spacing: 0.04em;
      text-shadow: 0 0 5px #0ff7; transition: color 0.2s, border 0.2s, background 0.2s;
      cursor: pointer;
    }
    .gmt-utc-clock.sync-error {
      color: #ffae47 !important;
      border-color: #ffc66a !important;
      background: #2d1c05ea !important;
      box-shadow: 0 0 18px #ffc66a77 !important;
    }
    .zona-horaria-label.gmt-central { font-weight: bold; }
    .city-clock-label {
      background: transparent !important; border: none !important; box-shadow: none !important; min-width: 0 !important; padding: 0 !important;
      font-family: 'Segoe UI', 'Roboto', sans-serif; color: #63faff;
      text-align: center;
      text-shadow: 0 0 8px #29eaffb8, 0 0 2px #09e7;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    .city-clock-label .hora {
      font-family: 'Consolas', monospace; font-size: 1.24em; color: #73fdff; font-weight: 800;
      margin-bottom: 0px; text-shadow: 0 0 13px #5efcff, 0 0 3px #33eaffb8; background: transparent; border: none; letter-spacing: 0.03em; line-height: 1.2;
    }
    .city-clock-label .city {
      font-size: 1em; color: #fff; font-weight: 600; margin-top: 0px; line-height: 1.08; background: transparent; border: none; text-shadow: 0 0 4px #00f8, 0 0 1px #0af9;
    }
    .leaflet-overlay-pane svg polyline {
      stroke: #2cfdff !important; filter: drop-shadow(0 0 6px #12fd) drop-shadow(0 0 2px #00f8); stroke-width: 2.3 !important; stroke-opacity: 0.65 !important;
    }
    #noticias-ticker {
      position: absolute; bottom:-40; left: 0; width: 100vw;
      z-index: 3000; background: rgba(8, 26, 31, 0.54); backdrop-filter: blur(2.5px);
      color: #6bf; font-family: 'Segoe UI', Arial, sans-serif; font-size: 1.13em;
      height: 33px; display: flex; align-items: center; overflow: hidden;
      border-top: 2px solid #13f5ff; box-shadow: 0 1px 7px #00f3;
      text-shadow: 0 0 8px #27fd;
    }
    #noticias-inner { white-space: nowrap; display: inline-block; will-change: transform; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="noticias-ticker"><span id="noticias-inner"></span></div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Mapa oscuro y capa GPS OSM
    const CENTER = [38.3373, -0.5266];
    const ZOOM = 3;
    const map = L.map('map', {
      zoomControl: false,
      attributionControl: false,
      minZoom: 2,
      maxZoom: 17,
      scrollWheelZoom: false,
      doubleClickZoom: false,
      boxZoom: false,
      dragging: false,
      touchZoom: false,
      keyboard: false
    }).setView(CENTER, ZOOM);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      maxZoom: 19, minZoom: 2, noWrap: true
    }).addTo(map);

    L.tileLayer('https://gps-{s}.tile.openstreetmap.org/lines/{z}/{x}/{y}.png', {
      maxZoom: 19, minZoom: 2, opacity: 0.85, noWrap: true
    }).addTo(map);

    // Zonas horarias y relojes
    const zonaHorariaLines = L.layerGroup();
    const relojMarkers = [];
    let utcRef = null, utcError = false;
    for(let i = -12; i <= 14; i++) {
      const lon = i * 15;
      if (lon < -180 || lon > 180) continue;
      const isCentral = (i === 0);
      const line = L.polyline([[-59.98, lon], [82.26, lon]],
        { color: "#2cfdff", weight: 2.3, opacity: 0.65, dashArray: "5,14", interactive: false });
      zonaHorariaLines.addLayer(line);
      const latLabel = 82.15;
      const relojId = `reloj-tz${i}`;
      const extraClass = isCentral ? " gmt-central" : "";
      const ancla = isCentral ? [52, 10] : [31, 10];
      const marker = L.marker([latLabel, lon], {
        icon: L.divIcon({
          className: 'zona-horaria-label' + extraClass,
          html: isCentral
            ? `<div class="gmt-utc-clock" id="${relojId}">--:--</div>`
            : `<div id="${relojId}" style="font-family:monospace;font-size:1.18em;color:#72fdff;background:transparent;padding:0;border:none;min-width:62px;text-align:center;box-shadow:none"></div>`,
          iconAnchor: ancla
        }),
        interactive: false
      });
      relojMarkers.push({ id: relojId, offset: i });
      zonaHorariaLines.addLayer(marker);
    }
    zonaHorariaLines.addTo(map);

    // Relojes de ciudades (iconAnchor afinado según tu prueba)
    const cityMarkers = [
      { name: "Los Ángeles", lat:34.05, lon:-118.25, utc_offset: -7, id:"clkla" },
      { name: "Denver", lat:39.74, lon:-104.99, utc_offset: -6, id:"clkden" },
      { name: "México", lat:19.43, lon:-99.13, utc_offset: -6, id:"clkcdmx" },
      { name: "Nueva York", lat:40.71, lon:-74.01, utc_offset: -4, id:"clkny" },
      { name: "Buenos Aires", lat:-34.61, lon:-58.38, utc_offset: -3, id:"clkbue" },
      { name: "Sao Paulo", lat:-23.55, lon:-46.63, utc_offset: -3, id:"clksp" },
      { name: "Londres", lat:51.51, lon:-0.13, utc_offset: 1, id:"clklon" },
      { name: "Madrid", lat:40.42, lon:-3.70, utc_offset: 2, id:"clkmad" },
      { name: "El Cairo", lat:30.05, lon:31.25, utc_offset: 2, id:"clkcai" },
      { name: "Moscú", lat:55.75, lon:37.62, utc_offset: 3, id:"clkmsk" },
      { name: "Dubái", lat:25.20, lon:55.27, utc_offset: 4, id:"clkdx" },
      { name: "Nueva Delhi", lat:28.61, lon:77.20, utc_offset: 5.5, id:"clkdel" },
      { name: "Pekín", lat:39.90, lon:116.40, utc_offset: 8, id:"clkpek" },
      { name: "Tokio", lat:35.68, lon:139.69, utc_offset: 9, id:"clktok" },
      { name: "Sídney", lat:-33.87, lon:151.21, utc_offset: 10, id:"clksyd" },
      { name: "Perth", lat:-31.95, lon:115.86, utc_offset: 8, id:"clkper" }
    ];
    cityMarkers.forEach(city => {
      L.marker([city.lat, city.lon], {
        icon: L.divIcon({
          className: "city-clock-label",
          html: `<span class="hora" id="${city.id}-hora">--:--</span>
                 <span class="city">${city.name}</span>`,
          iconAnchor: [11, 10]
        }),
        interactive: false
      }).addTo(map);
    });

    // Sincronización GMT central
    async function syncUTCAtomic() {
      try {
        const resp = await fetch('https://timeapi.io/api/Time/current/zone?timeZone=UTC');
        const data = await resp.json();
        utcRef = new Date(data.dateTime);
        utcError = false;
      } catch(e) {
        let now = new Date();
        let localOffsetMinutes = now.getTimezoneOffset();
        utcRef = new Date(now.getTime() + localOffsetMinutes * 60000);
        utcError = true;
      }
      updateCentralUTCAndRelojes();
    }

    function updateCentralUTCAndRelojes() {
      if (!utcRef) return;
      let h = String(utcRef.getUTCHours()).padStart(2,"0");
      let m = String(utcRef.getUTCMinutes()).padStart(2,"0");
      const centralClock = document.getElementById('reloj-tz0');
      if (centralClock) {
        centralClock.textContent = `${h}:${m}`;
        if (utcError) {
          centralClock.classList.add('sync-error');
          centralClock.title = "Error en servidor, hora sincronizada con reloj del sistema";
        } else {
          centralClock.classList.remove('sync-error');
          centralClock.title = "Hora GMT/UTC atómica sincronizada";
        }
      }
      relojMarkers.forEach(({id, offset}) => {
        if (id === 'reloj-tz0') return;
        const el = document.getElementById(id);
        if (!el) return;
        const t = new Date(utcRef.getTime() + offset * 60 * 60 * 1000);
        const hh = String(t.getUTCHours()).padStart(2, "0");
        const mm = String(t.getUTCMinutes()).padStart(2, "0");
        el.textContent = `${hh}:${mm}`;
      });
      cityMarkers.forEach(city => {
        const el = document.getElementById(city.id + "-hora");
        if (!el) return;
        const t = new Date(utcRef.getTime() + city.utc_offset * 60 * 60 * 1000);
        const hh = String(t.getUTCHours()).padStart(2, "0");
        const mm = String(t.getUTCMinutes()).padStart(2, "0");
        el.textContent = `${hh}:${mm}`;
      });
    }
    syncUTCAtomic();
    setInterval(syncUTCAtomic, 5 * 60 * 1000);
    setInterval(updateCentralUTCAndRelojes, 10000);

    // -------- TICKER DE NOTICIAS TRADUCIDAS --------
    const rssFeeds = [
      { url: "https://www.securitylab.ru/_Services/Export/XmlExport_RSS.aspx?News", nombre: "SecurityLab.ru" },
      { url: "https://www.kaspersky.com/blog/feed/", nombre: "Kaspersky" },
      { url: "https://www.incibe.es/feed", nombre: "INCIBE" },
      { url: "https://www.securityweek.com/rss", nombre: "SecurityWeek" },
      { url: "https://www.darkreading.com/rss.xml", nombre: "Dark Reading" }
    ];

    async function traducir(texto, idioma = "es") {
      const url = '/.netlify/functions/traducir?texto=' + encodeURIComponent(texto) + "&to=" + idioma;
      const resp = await fetch(url);
      const data = await resp.json();
      return data.traduccion || texto;
    }

    async function lanzarTicker() {
      const inner = document.getElementById('noticias-inner');
      let noticias = [];

      for (let feed of rssFeeds) {
        try {
          let url = `https://rss2json.com/api.json?rss_url=${encodeURIComponent(feed.url)}`;
          const resp = await fetch(url);
          const data = await resp.json();
          if (data.status === "ok") {
            for (let item of data.items.slice(0, 2)) {
              noticias.push({
                titulo: item.title,
                enlace: item.link,
                fuente: feed.nombre
              });
            }
          }
        } catch {}
      }

      noticias = noticias.slice(0, 10);

      for (let noticia of noticias) {
        noticia.titulo = await traducir(noticia.titulo);
      }

      let sep = `<span style="color:#44c4ff;font-size:1.2em;font-weight:bold;">&nbsp;&nbsp;•&nbsp;&nbsp;</span>`;
      inner.innerHTML = noticias.map(n =>
        `<a href="${n.enlace}" target="_blank" style="color:#9ff;text-decoration:none;font-weight:bold;" title="${n.fuente}">${n.titulo}</a>`
      ).join(sep);

      setTimeout(() => {
        const ancho = inner.offsetWidth / 2;
        const dur = Math.max(24, inner.textContent.length / 9);
        inner.getAnimations().forEach(a => a.cancel());
        inner.animate([
          { transform: "translateX(0)" },
          { transform: `translateX(-${ancho}px)` }
        ], {
          duration: dur * 1000,
          iterations: Infinity,
          easing: "linear"
        });
      }, 100);
    }

    lanzarTicker();
    setInterval(lanzarTicker, 15 * 60 * 1000);

  </script>
</body>
</html>
