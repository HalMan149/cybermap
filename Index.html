<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Mapa de ataques ransomware</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { width: 100vw; height: 100vh; margin:0; padding:0; background: #161d2d; }
    #map { width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; z-index: 1; }
    #ataques-ransomware {
      position:absolute; top:70px; right:36px; z-index:9999;
      background:rgba(0,0,0,0.80); color:#46fff2; padding:12px 16px 12px 18px; border-radius:13px;
      min-width:256px; font-size:1.07em; font-family:sans-serif;
      max-width:430px; box-shadow: 0 0 18px #09e4;
      transition: all 0.15s;
    }
    #ataques-ransomware b { color: #fff37d; }
    #ataques-ransomware ul { margin: 10px 0 0 0; padding-left: 19px; }
    #ataques-ransomware li { margin-bottom:6px; }
    .error-msg { color:#fa7; font-weight:bold; }
    .ok-msg { color:#aef; font-weight:bold; }
    #btn-toggle-lista {
      position: absolute;
      top: 26px;
      right: 32px;
      z-index: 10000;
      padding: 7px 12px 5px 12px;
      border-radius: 15px;
      border: none;
      background: #202c40e9;
      color: #31fff5;
      font-size: 2.0em;
      font-weight: 700;
      box-shadow: 0 0 7px #0ef6;
      cursor: pointer;
      transition: background .15s;
    }
    #noticias-ticker {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100vw;
      z-index: 3000;
      background: rgba(24, 27, 31, 0.45);
      backdrop-filter: blur(2.5px);
      color: #ffeec0;
      font-family: 'Segoe UI', Arial, sans-serif;
      font-size: 1.15em;
      height: 32px;
      display: flex;
      align-items: center;
      overflow: hidden;
      border-top: 2px solid #3840e5;
      cursor: pointer;
    }
    #noticias-inner {
      white-space: nowrap;
      display: inline-block;
      will-change: transform;
    }
    /* Relojes y barras horarias */
    .clock-bar {
      position: absolute;
      left: 0;
      right: 0;
      top: 44px;
      height: 22px;
      z-index: 10002;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      gap: 8px;
    }
    .clock {
      display: inline-block;
      min-width: 92px;
      background: #282c35cc;
      color: #ffecc0;
      font-size: 1.15em;
      padding: 3px 13px 2px 13px;
      border-radius: 9px;
      text-align: center;
      margin: 0 3px;
      box-shadow: 0 0 3px #000b;
      font-family: monospace;
      pointer-events: auto;
      transition: background 0.15s;
    }
    .clock .city { font-size: 0.88em; color: #fff37d; }
    .clock .tz { font-size: 0.85em; color: #80ffd2; margin-left: 4px; }
    .clock.local { border: 2px solid #25e8ff; }
  </style>
</head>
<body>
  <div id="map"></div>
  <button id="btn-toggle-lista" title="Mostrar/Ocultar ataques">☰</button>
  <div id="ataques-ransomware">
    <b>Últimos ataques ransomware</b>
    <ul id="lista-ataques"></ul>
  </div>
  <div class="clock-bar" id="clock-bar">
    <!-- Relojes insertados aquí por JS -->
  </div>
  <div id="noticias-ticker"><span id="noticias-inner"></span></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Mapa base y capas
    const CENTER = [38.3373, -0.5266];
    const ZOOM = 3;
    const map = L.map('map', {
      zoomControl: false,
      attributionControl: false,
      minZoom: 2,
      maxZoom: 17,
      scrollWheelZoom: false,
      doubleClickZoom: false,
      boxZoom: false,
      dragging: false,
      touchZoom: false,
      keyboard: false
    }).setView(CENTER, ZOOM);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      maxZoom: 19, minZoom: 2, noWrap: true
    }).addTo(map);

    L.tileLayer('https://gps-{s}.tile.openstreetmap.org/lines/{z}/{x}/{y}.png', {
      maxZoom: 19, minZoom: 2, opacity: 0.85, noWrap: true
    }).addTo(map);

    // Gradiente por ataques (choropleth)
    let geojsonLayer;
    async function pintarMapaChoropleth(ataquesPorPais) {
      if (geojsonLayer) map.removeLayer(geojsonLayer);

      const resp = await fetch('/countries.geojson');
      const worldGeo = await resp.json();

      const ataquesPorPaisNorm = {};
      for (const k in ataquesPorPais) {
        ataquesPorPaisNorm[k.toUpperCase()] = ataquesPorPais[k];
      }
      const maxAtaques = Math.max(...Object.values(ataquesPorPaisNorm), 1);

      geojsonLayer = L.geoJSON(worldGeo, {
        style: feature => {
          const code = feature.properties.ISO_A2 ? feature.properties.ISO_A2.toUpperCase() : null;
          const n = code ? (ataquesPorPaisNorm[code] || 0) : 0;
          let color;
          if (!code) color = "#26292f";
          else if (n === 0) color = "#22242a";
          else if (n === maxAtaques) color = "#ff0066";
          else color = `hsl(${220 - Math.round((n / maxAtaques) * 180)}, 100%, 55%)`;
          return {
            fillColor: color,
            fillOpacity: !code ? 0.03 : (n === 0 ? 0.07 : 0.21 + 0.37 * (n / maxAtaques)),
            color: "#25efff",
            weight: 1.3,
            opacity: 0.6
          };
        }
      }).addTo(map);
    }

    // Diccionario de países (coordenadas)
    const countryCoords = {
      "US": [39.8, -98.6], "JP": [36.2, 138.2], "FR": [46.6, 2.6], "GB": [54.8, -4.6], "DE": [51.2, 10.5],
      "IT": [42.9, 12.7], "IL": [31.4, 34.9], "TH": [15.8, 100.5], "RU": [61.5, 105.3], "ES": [40.4, -3.7],
      "BR": [-14.2, -51.9], "CN": [35.9, 104.2], "CA": [56.1, -106.3], "AU": [-25.2, 133.8], "MX": [23.6, -102.5],
      "IN": [21.1, 78.0], "TR": [39.1, 35.1], "KR": [36.5, 127.8], "ZA": [-29.0, 24.7], "AR": [-38.4, -63.6],
      "CH": [46.8, 8.2], "PT": [39.4, -8.2], "PL": [52.1, 19.4], "NL": [52.3, 5.3], "BE": [50.5, 4.4]
    };

    let attackMarkers = [];

    // Función principal de ataques
    async function cargarAtaques() {
      attackMarkers.forEach(m => map.removeLayer(m));
      attackMarkers = [];
      const lista = document.getElementById('lista-ataques');
      lista.innerHTML = '<li>Cargando datos...</li>';
      try {
        const resp = await fetch('/.netlify/functions/ransomware');
        const data = await resp.json();

        if (!Array.isArray(data)) {
          console.error("Respuesta inesperada de la API:", data);
          lista.innerHTML = `<li class="error-msg">Error: respuesta inesperada del servidor.</li>`;
          return;
        }
        if (data.length === 0) {
          lista.innerHTML = '<li class="ok-msg">No hay ataques recientes registrados.</li>';
          return;
        }
        // --- Recuento de ataques por país y gradiente ---
        const ataquesPorPais = {};
        data.forEach(ataque => {
          if (ataque.country) {
            const code = ataque.country.toUpperCase();
            ataquesPorPais[code] = (ataquesPorPais[code] || 0) + 1;
          }
        });
        pintarMapaChoropleth(ataquesPorPais);

        lista.innerHTML = "";
        data.slice(0, 25).forEach(ataque => {
          const pais = ataque.country || "-";
          const li = document.createElement('li');
          li.innerHTML = `<b>${ataque.victim || "Desconocido"}</b>
            <span style="opacity:0.7;">(${pais})</span>
            <br><small>${ataque.title || ""}</small>`;
          lista.appendChild(li);

          if (ataque.country && countryCoords[ataque.country]) {
            const marker = L.circleMarker(countryCoords[ataque.country], {
              radius: 8, color: "#ff317a", fillColor: "#ff317a", fillOpacity: 0.82
            }).addTo(map).bindPopup(
              `<b>${ataque.victim || "Desconocido"}</b><br>
               <b>Dominio:</b> ${ataque.domain || "-"}<br>
               <b>Fecha:</b> ${ataque.date || "-"}<br>
               <b>Titular:</b> ${ataque.title || ""}<br>
               <b>País:</b> ${ataque.country}<br>
               <b>Resumen:</b> <span style="font-size:0.95em">${ataque.summary || ""}</span><br>
               <a href="${ataque.url}" target="_blank" style="color:#37f;">[Fuente]</a>`
            );
            attackMarkers.push(marker);
          }
        });
      } catch (e) {
        lista.innerHTML = `<li class="error-msg">Error de conexión con el servidor.<br><span style="font-size:0.92em;">${e.message || e}</span></li>`;
      }
    }
    cargarAtaques();
    setInterval(cargarAtaques, 4 * 60 * 1000);

    // Panel ataques (mostrar/ocultar)
    document.getElementById("btn-toggle-lista").onclick = function() {
      const panel = document.getElementById("ataques-ransomware");
      panel.style.display = (panel.style.display === "none" ? "block" : "none");
    };

    // =================== Relojes de ciudades ===================
    // (Si tienes funciones aquí para tus relojes y barras horarias, ponlas debajo)
    // Ejemplo (puedes sustituir por tu propio código):
    const relojes = [
      { city: "Madrid", tz: "Europe/Madrid" },
      { city: "Londres", tz: "Europe/London" },
      { city: "Nueva York", tz: "America/New_York" },
      { city: "Tokio", tz: "Asia/Tokyo" },
      { city: "Sidney", tz: "Australia/Sydney" }
    ];
    function renderRelojes() {
      const bar = document.getElementById("clock-bar");
      bar.innerHTML = "";
      relojes.forEach(r => {
        const now = new Date().toLocaleString("es-ES", { timeZone: r.tz, hour: "2-digit", minute: "2-digit", hour12: false });
        const div = document.createElement("div");
        div.className = "clock";
        div.innerHTML = `<span class="city">${r.city}</span><span class="tz">(${r.tz.split("/")[1] || ""})</span><br><b>${now}</b>`;
        bar.appendChild(div);
      });
    }
    renderRelojes();
    setInterval(renderRelojes, 30000);

    // =================== Ticker de noticias (puedes poner aquí tu propio código traducido) ===================
    async function cargarNoticiasTicker() {
      const ticker = document.getElementById('noticias-ticker');
      const inner = document.getElementById('noticias-inner');
      inner.textContent = "Cargando noticias...";
      try {
        const rssUrls = [
          "https://feeds.elpais.com/mrss-s/pages/ep/site/elpais.com/section/internacional/portada"
        ];
        const keywords = [
          "guerra", "conflicto", "crisis", "ataque", "bombardeo", "frontera",
          "tregua", "combate", "militar", "invasión", "misil", "terrorismo", "refugiados", "emergencia"
        ];
        const results = await Promise.all(rssUrls.map(url => fetch(url).then(r => r.text())));
        let titulares = [];
        results.forEach(txt => {
          let parser = new DOMParser();
          let xml = parser.parseFromString(txt, "application/xml");
          let items = Array.from(xml.querySelectorAll("item"));
          titulares = titulares.concat(items.map(it => it.querySelector("title")?.textContent || "").filter(Boolean));
        });
        titulares = Array.from(new Set(titulares))
          .filter(titular => keywords.some(kw => titular.toLowerCase().includes(kw)))
          .slice(0, 20);

        let sep = `<span style="color:#44c4ff;font-size:1.2em;font-weight:bold;">&nbsp;&bull;&nbsp;</span>`;
        if (titulares.length === 0) {
          inner.textContent = "No hay titulares internacionales destacados ahora mismo.";
        } else {
          inner.innerHTML = titulares.join(sep) + sep + titulares.join(sep);
        }
        setTimeout(() => {
          if (titulares.length > 0) {
            const ancho = inner.offsetWidth / 2;
            const dur = Math.max(24, inner.textContent.length / 8);
            inner.getAnimations().forEach(a => a.cancel());
            inner.animate([
              { transform: "translateX(0)" },
              { transform: `translateX(-${ancho}px)` }
            ], {
              duration: dur * 1000,
              iterations: Infinity,
              easing: "linear"
            });
          }
        }, 0);
      } catch(e) {
        inner.textContent = "No se pudieron cargar noticias internacionales.";
      }
    }
    cargarNoticiasTicker();
  </script>
</body>
</html>
