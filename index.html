<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>Portal Geof√≠sico y Ciberseguridad</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0a0e1a;
      background-image: 
        radial-gradient(circle at 20% 50%, rgba(109, 213, 237, 0.03) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(255, 179, 71, 0.03) 0%, transparent 50%),
        repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(109, 213, 237, 0.03) 2px, rgba(109, 213, 237, 0.03) 4px);
      color: #fff;
      overflow-x: hidden;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    /* ========== TICKER DE NOTICIAS (ARRIBA) ========== */
    .news-ticker {
      background: linear-gradient(90deg, #1a1d2e 0%, #2a2d3e 100%);
      padding: 12px 0;
      border-bottom: 2px solid #3a4d6e;
      overflow: hidden;
      position: relative;
      height: 50px;
      display: flex;
      align-items: center;
    }
    
    .news-ticker-content {
      display: flex;
      white-space: nowrap;
      animation: scroll-left 60s linear infinite;
      gap: 60px;
    }
    
    .news-item {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      color: #e0e6ed;
      cursor: pointer;
      transition: color 0.3s;
    }
    
    .news-item:hover {
      color: #6dd5ed;
    }
    
    .news-icon {
      font-size: 18px;
    }
    
    @keyframes scroll-left {
      0% { transform: translateX(0); }
      100% { transform: translateX(-50%); }
    }
    
    /* ========== CONTENEDOR PRINCIPAL ========== */
    .main-container {
      display: grid;
      grid-template-columns: 280px 1fr 280px;
      gap: 20px;
      padding: 20px;
      flex: 1;
      overflow: hidden;
    }
    
    /* ========== PANEL LUNA (IZQUIERDA) ========== */
    .moon-panel {
      background: linear-gradient(135deg, #1a1d2e 0%, #2a2d3e 100%);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }
    
    .moon-panel h3 {
      font-size: 16px;
      color: #6dd5ed;
      text-align: center;
    }
    
    #moonCanvas {
      width: 160px;
      height: 160px;
      border-radius: 50%;
      display: none;
    }
    
    #moonImage {
      width: 160px;
      height: 160px;
      border-radius: 50%;
      object-fit: cover;
    }
    
    .moon-container {
      width: 200px;
      height: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
      border-radius: 50%;
      box-shadow: 0 4px 20px rgba(109, 213, 237, 0.3);
    }
    
    .moon-info {
      text-align: center;
      font-size: 13px;
      line-height: 1.6;
    }
    
    .moon-info strong {
      color: #6dd5ed;
    }
    
    /* ========== MAPAS CENTRALES ========== */
    /* Para miniaturas apiladas (uno encima de otro) */
    .maps-container {
      display: flex;
      flex-direction: column;
      gap: 16px;
      overflow-y: auto;
      align-items: stretch;
      padding-top: 8px;   /* baja ligeramente los marcos centrales */
      padding-bottom: 8px;
    }
    
    .map-card {
      background: linear-gradient(135deg, #1a1d2e 0%, #2a2d3e 100%);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 
        0 8px 32px rgba(0,0,0,0.4),
        0 0 0 1px rgba(109, 213, 237, 0.2),
        inset 0 1px 0 rgba(255,255,255,0.05);
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      min-height: 320px;  /* m√°s altura para acercar la proporci√≥n a los paneles laterales */
      display: flex;
      flex-direction: column;
      border: 1px solid rgba(109, 213, 237, 0.15);
    }
    
    .map-card:hover {
      transform: translateY(-5px);
      box-shadow: 
        0 16px 48px rgba(109, 213, 237, 0.3),
        0 0 0 2px rgba(109, 213, 237, 0.4),
        inset 0 1px 0 rgba(255,255,255,0.1);
      border-color: rgba(109, 213, 237, 0.5);
    }
    
    .map-header {
      padding: 15px 20px;
      background: rgba(26, 29, 46, 0.8);
      border-bottom: 2px solid #3a4d6e;
    }
    
    .map-header h3 {
      font-size: 18px;
      color: #6dd5ed;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .map-header p {
      font-size: 13px;
      color: #a0aec0;
      margin-top: 5px;
    }
    
    .map-preview {
      flex: 1;
      background: #0a0e1a;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 6px;  /* menos marco para mostrar m√°s mapa */
      position: relative;
      overflow: hidden;
      aspect-ratio: 1 / 1;   /* Proporci√≥n cuadrada para mostrar m√°s mapa y menos recorte */
      min-height: 320px;      /* incremento para equilibrar altura con laterales */
    }
    /* Para la tarjeta cyber: formato 16:9 y altura mayor */
    .cyber-card .map-preview {
      aspect-ratio: 16 / 9;
      min-height: 480px;
      padding: 0;
      position: relative;
      overflow: hidden;
    }
    
    .map-preview img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      opacity: 0.7;
      transition: opacity 0.3s;
    }
    
    .map-card:hover .map-preview img {
      opacity: 1;
    }

    /* Miniaturas responsivas: en pantallas m√°s estrechas, formato casi cuadrado */
    @media (max-width: 1200px) {
      .map-preview {
        aspect-ratio: 1 / 1;
        min-height: 220px;
      }
    }
    
    .map-placeholder {
      font-size: 14px;
      color: #718096;
      text-align: center;
      opacity: 0.5;
      letter-spacing: 1px;
    }
    
    .map-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 16px;
      color: #6dd5ed;
      background: rgba(10, 14, 26, 0.9);
      padding: 10px 20px;
      border-radius: 8px;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
    }
    
    .map-card:hover .map-overlay {
      opacity: 1;
    }
    
    /* ========== PANEL SOL (DERECHA) ========== */
    .sun-panel {
      background: linear-gradient(135deg, #1a1d2e 0%, #2a2d3e 100%);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }
    
    .sun-panel h3 {
      font-size: 16px;
      color: #6dd5ed;
      text-align: center;
    }
    
    
    .image-error {
      width: 160px;
      height: 160px;
      border-radius: 50%;
      background: #1a1d2e;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      font-size: 12px;
      color: #718096;
      padding: 20px;
      border: 2px dashed rgba(109, 213, 237, 0.3);
      font-weight: 500;
      letter-spacing: 0.5px;
    }
    
    .sun-info {
      text-align: center;
      font-size: 12px;
      line-height: 1.6;
      color: #a0aec0;
    }
    
    .sun-graphs {
      width: 100%;
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 8px;
    }
    
    .graph-card {
      background: rgba(26, 29, 46, 0.75);
      border: 1px solid rgba(109, 213, 237, 0.25);
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.25);
    }
    
    .graph-title {
      font-size: 12px;
      color: #6dd5ed;
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .graph-title small {
      color: #a0aec0;
    }
    
    .graph-card img {
      width: 100%;
      border-radius: 6px;
      border: 1px solid rgba(109, 213, 237, 0.15);
      background: #0a0e1a;
    }
    
    .graph-fallback {
      font-size: 12px;
      color: #718096;
      text-align: center;
      padding: 12px;
      background: #0a0e1a;
      border-radius: 6px;
      border: 1px dashed rgba(109, 213, 237, 0.2);
    }
    
    /* ========== INFO CONEXI√ìN (ABAJO) ========== */
    .connection-bar {
      background: linear-gradient(90deg, #1a1d2e 0%, #2a2d3e 100%);
      padding: 12px 20px;
      border-top: 2px solid #3a4d6e;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .connection-bar:hover {
      background: linear-gradient(90deg, #2a2d3e 0%, #3a3d4e 100%);
    }
    
    .connection-basic {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
    }
    
    .connection-items {
      display: flex;
      gap: 30px;
      align-items: center;
    }
    
    .connection-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .connection-item .icon {
      font-size: 16px;
    }
    
    .status-online {
      color: #48bb78;
    }
    
    .status-offline {
      color: #f56565;
    }
    
    .expand-btn {
      color: #6dd5ed;
      font-size: 18px;
      transition: transform 0.3s;
    }
    
    .expand-btn.expanded {
      transform: rotate(180deg);
    }
    
    .connection-expanded {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    
    .connection-expanded.show {
      max-height: 300px;
    }
    
    .connection-details {
      padding: 20px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      border-top: 1px solid #3a4d6e;
      margin-top: 10px;
    }
    
    .detail-item {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    
    .detail-label {
      font-size: 11px;
      color: #718096;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .detail-value {
      font-size: 14px;
      color: #e0e6ed;
      font-weight: 500;
    }
    
    /* ========== RESPONSIVE ========== */
    @media (max-width: 1200px) {
      .main-container {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr auto;
      }
      
      .moon-panel, .sun-panel {
        flex-direction: row;
        justify-content: center;
      }
      
      #moonCanvas, #sdoImage {
        width: 150px;
        height: 150px;
      }
    }
    
    /* ========== LOADING ========== */
    .loading {
      color: #6dd5ed;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
  </style>
</head>
<body>
  
  <!-- TICKER DE NOTICIAS -->
  <div class="news-ticker">
    <div class="news-ticker-content" id="newsTicker">
      <!-- Se llenar√° din√°micamente -->
    </div>
  </div>
  
  <!-- CONTENEDOR PRINCIPAL -->
  <div class="main-container">
    
    <!-- PANEL LUNA (IZQUIERDA) -->
    <div class="moon-panel">
      <h3>Fase Lunar</h3>
      <div class="moon-container">
        <img id="moonImage" alt="Fase Lunar" style="display: none;"/>
        <canvas id="moonCanvas" width="320" height="320" style="display: none;"></canvas>
        <div id="moonError" class="image-error" style="display: none;">
          FUENTE NO DISPONIBLE<br>
          <small style="font-size: 11px; margin-top: 8px; display: block;">NASA SVS offline</small>
        </div>
      </div>
      <div class="moon-info" id="moonInfo">
        <div class="loading">Calculando...</div>
      </div>
    </div>
    
    <!-- MAPAS CENTRALES -->
    <div class="maps-container">
      
      <!-- Mapa Tierra (Terremotos y Volcanes) -->
      <div class="map-card" onclick="window.open('mapa_tierra_v2.html', '_blank')">
        <div class="map-header">
          <h3>Mapa Terrestre Geol√≥gico</h3>
        </div>
        <div class="map-preview">
          <!-- Miniatura interactiva (solo vista previa, sin interacci√≥n) -->
          <iframe 
            src="mapa_tierra_v2.html?preview=1" 
            title="Mini mapa terrestre" 
            id="mini-earth"
            style="width: 130%; height: 130%; border: none; border-radius: 12px; overflow: hidden; pointer-events: none; filter: contrast(1) brightness(1); transform: scale(0.95); transform-origin: center;"
            loading="lazy">
          </iframe>
          <div class="map-overlay">Click para abrir ‚Üí</div>
        </div>
      </div>
      
      <!-- Mapa Cyberataques -->
      <div class="map-card cyber-card" onclick="window.open('mapa_cyber.html', '_blank')">
        <div class="map-header">
          <h3>Mapa Cybern√©tico</h3>
        </div>
        <div class="map-preview">
          <iframe 
            id="mini-cyber"
            src="mapa_cyber.html?preview=1" 
            title="Mini mapa cyber" 
            style="position: absolute; top: 50%; left: 50%; width: 220%; height: 220%; border: none; border-radius: 12px; overflow: hidden; pointer-events: none; filter: contrast(1) brightness(1); transform: translate(-50%, -50%) scale(1.0); transform-origin: center;"
            loading="lazy">
          </iframe>
          <div class="map-overlay">Click para abrir ‚Üí</div>
        </div>
      </div>
      
      <!-- Mapa Espa√±a -->
      <div class="map-card" onclick="alert('Mapa de Espa√±a - Pr√≥ximamente')">
        <div class="map-header">
          <h3>Mapa de Espa√±a</h3>
        </div>
        <div class="map-preview">
          <div class="map-placeholder">
            EN DESARROLLO<br>
            <small style="font-size: 11px; margin-top: 8px; display: block;">Pr√≥ximamente</small>
          </div>
        </div>
      </div>
      
    </div>
    
    <!-- PANEL SOL (DERECHA) -->
    <div class="sun-panel">
      <h3>Estado del Sol</h3>
      <div style="width: 200px; height: 200px; display: flex; align-items: center; justify-content: center; background: #000; border-radius: 50%; box-shadow: 0 4px 20px rgba(255, 179, 71, 0.3);">
        <img id="sdoImage" src="https://sdo.gsfc.nasa.gov/assets/img/latest/f_HMImag_171_1024.jpg" alt="Sol SDO" 
             onerror="handleSDOError(this)" style="display: block; width: 200px; height: 200px; border-radius: 50%; object-fit: cover;"/>
        <div id="sdoError" class="image-error" style="display: none; width: 200px; height: 200px;">
          FUENTE NO DISPONIBLE<br>
          <small style="font-size: 11px; margin-top: 8px; display: block;">SDO/NASA offline</small>
        </div>
      </div>
      <div class="sun-info">
        <strong>HMI Magnetogram + AIA 171</strong><br>
        <small style="color: #48bb78;">SDO/NASA</small><br>
        Actualizaci√≥n: <span id="sdoTime">Cargando...</span>
      </div>
      <div class="sun-graphs">
        <div class="graph-card">
          <div class="graph-title">
            <span>Flujo X-ray GOES (0.1-0.8 nm)</span>
            <small>NOAA SWPC</small>
          </div>
          <img src="https://services.swpc.noaa.gov/images/goes-xrays-6-hour.gif" alt="GOES X-ray" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
          <div class="graph-fallback" style="display:none;">Gr√°fico no disponible ahora mismo.</div>
        </div>
        <div class="graph-card">
          <div class="graph-title">
            <span>Viento solar (Velocidad / Proton Flux)</span>
            <small>ACE / DSCOVR</small>
          </div>
          <img src="https://services.swpc.noaa.gov/images/ace-swepam-24-hour.gif" alt="Solar wind" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
          <div class="graph-fallback" style="display:none;">Gr√°fico no disponible ahora mismo.</div>
        </div>
      </div>
    </div>
    
  </div>
  
  <!-- BARRA DE CONEXI√ìN (ABAJO) -->
  <div class="connection-bar" onclick="toggleConnection()">
    <div class="connection-basic">
      <div class="connection-items">
        <div class="connection-item">
          <span class="icon">üåê</span>
          <span id="userIP">Cargando IP...</span>
        </div>
        <div class="connection-item">
          <span class="icon">üìç</span>
          <span id="userLocation">Cargando...</span>
        </div>
        <div class="connection-item">
          <span class="icon">‚ö°</span>
          <span id="userPing">-- ms</span>
        </div>
        <div class="connection-item">
          <span class="icon status-online" id="statusIcon">‚úì</span>
          <span id="statusText">Online</span>
        </div>
      </div>
      <div class="expand-btn" id="expandBtn">‚ñº</div>
    </div>
    
    <div class="connection-expanded" id="connectionDetails">
      <div class="connection-details">
        <div class="detail-item">
          <span class="detail-label">IP P√∫blica</span>
          <span class="detail-value" id="detailIP">--</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Ubicaci√≥n</span>
          <span class="detail-value" id="detailLocation">--</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">ISP</span>
          <span class="detail-value" id="detailISP">--</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Navegador</span>
          <span class="detail-value" id="detailBrowser">--</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Sistema</span>
          <span class="detail-value" id="detailOS">--</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Resoluci√≥n</span>
          <span class="detail-value" id="detailResolution">--</span>
        </div>
      </div>
    </div>
  </div>
  
  <script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>
  <script>
    'use strict';
    
    // ========== NOTICIAS (TICKER CON CACHE) ==========
    const NEWS_CACHE_KEY = 'cached_news';
    const NEWS_CACHE_DURATION = 3600000; // 1 hora
    const AEMET_API_KEY = 'eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJoYWxtYW4xNDlAaG90bWFpbC5jb20iLCJqdGkiOiI3ZGQ5ZTVmNi1lNDEwLTQzZmMtYjNhOC04MGI3NzM2NmVkYTYiLCJpc3MiOiJBRU1FVCIsImlhdCI6MTc2NDg4MzUyMSwidXNlcklkIjoiN2RkOWU1ZjYtZTQxMC00M2ZjLWIzYTgtODBiNzczNjZlZGE2Iiwicm9sZSI6IiJ9.jGtqvEyxNK9InPB75V4xm8KBQn_r1etLlPO8LUqyuys';
    
    const FALLBACK_NEWS = [
      { icon: 'üåç', text: 'Sistema de monitoreo geof√≠sico activo', url: '#' },
      { icon: 'üåã', text: 'Red de vigilancia volc√°nica operativa', url: '#' },
      { icon: '‚òÄÔ∏è', text: 'Monitoreo solar SDO/NASA en l√≠nea', url: '#' },
      { icon: 'üîí', text: 'Sistema de ciberseguridad actualizado', url: '#' },
      { icon: 'üå°Ô∏è', text: 'Monitoreo meteorol√≥gico Espa√±a operativo', url: '#' },
      { icon: 'üõ∞Ô∏è', text: 'Seguimiento ISS en tiempo real', url: '#' },
      { icon: 'üì°', text: 'Conexi√≥n a fuentes de datos establecida', url: '#' },
      { icon: 'üåê', text: 'Portal geof√≠sico en tiempo real', url: '#' }
    ];
    
    async function fetchRealNews() {
      try {
        const allNews = [];
        
        // 1. TERREMOTOS SIGNIFICATIVOS (USGS)
        try {
          const quakeResponse = await fetch('https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/significant_week.geojson', { 
            signal: AbortSignal.timeout(8000) 
          });
          const quakeData = await quakeResponse.json();
          
          if (quakeData.features && quakeData.features.length > 0) {
            quakeData.features.slice(0, 3).forEach(quake => {
              const mag = quake.properties.mag.toFixed(1);
              const place = quake.properties.place;
              allNews.push({
                icon: 'üåç',
                text: `Terremoto M${mag} en ${place}`,
                url: quake.properties.url || '#'
              });
            });
          }
        } catch (e) {
          console.warn('‚ö†Ô∏è Error terremotos USGS:', e.message);
        }
        
        // 2. CLIMA ESPACIAL (NOAA Space Weather con proxy)
        try {
          const spaceUrl = 'https://services.swpc.noaa.gov/products/alerts.json';
          const spaceResponse = await fetch(`https://corsproxy.io/?${encodeURIComponent(spaceUrl)}`, {
            signal: AbortSignal.timeout(8000)
          });
          const spaceData = await spaceResponse.json();
          
          if (spaceData && spaceData.length > 0) {
            spaceData.slice(0, 2).forEach(alert => {
              const message = alert.message || alert.summary || '';
              if (message.length > 10 && message.length < 100) {
                allNews.push({
                  icon: '‚òÄÔ∏è',
                  text: message.substring(0, 80),
                  url: 'https://www.swpc.noaa.gov/'
                });
              }
            });
          }
        } catch (e) {
          console.warn('‚ö†Ô∏è Error clima espacial NOAA:', e.message);
        }
        
        // 3. HURACANES/CICLONES ACTIVOS (NOAA con proxy)
        try {
          const hurricaneUrl = 'https://www.nhc.noaa.gov/CurrentStorms.json';
          const hurricaneResponse = await fetch(`https://corsproxy.io/?${encodeURIComponent(hurricaneUrl)}`, {
            signal: AbortSignal.timeout(8000)
          });
          const hurricaneData = await hurricaneResponse.json();
          
          if (hurricaneData.activeStorms && hurricaneData.activeStorms.length > 0) {
            hurricaneData.activeStorms.slice(0, 2).forEach(storm => {
              const name = storm.name || storm.stormName || 'Sin nombre';
              const type = storm.stormType || 'Tormenta';
              allNews.push({
                icon: 'üåÄ',
                text: `${type} ${name} activo`,
                url: 'https://www.nhc.noaa.gov/'
              });
            });
          }
        } catch (e) {
          console.warn('‚ö†Ô∏è Error huracanes NOAA:', e.message);
        }
        
        // 4. ESTACI√ìN ESPACIAL INTERNACIONAL (ISS con proxy)
        try {
          const issUrl = 'http://api.open-notify.org/iss-now.json';
          const issResponse = await fetch(`https://corsproxy.io/?${encodeURIComponent(issUrl)}`, {
            signal: AbortSignal.timeout(8000)
          });
          const issData = await issResponse.json();
          
          if (issData.iss_position) {
            const lat = parseFloat(issData.iss_position.latitude).toFixed(1);
            const lon = parseFloat(issData.iss_position.longitude).toFixed(1);
            
            // Determinar regi√≥n aproximada
            let region = 'Oc√©ano';
            if (lat > 35 && lat < 45 && lon > -10 && lon < 5) region = 'Europa';
            else if (lat > 25 && lat < 50 && lon > -130 && lon < -60) region = 'Am√©rica del Norte';
            else if (lat > -60 && lat < 15 && lon > -85 && lon < -30) region = 'Am√©rica del Sur';
            else if (lat > -40 && lat < 40 && lon > 95 && lon < 150) region = 'Asia-Pac√≠fico';
            
            allNews.push({
              icon: 'üõ∞Ô∏è',
              text: `ISS sobrevolando ${region} (${lat}¬∞, ${lon}¬∞)`,
              url: 'https://spotthestation.nasa.gov/'
            });
          }
        } catch (e) {
          console.warn('‚ö†Ô∏è Error ISS tracker:', e.message);
        }
        
        // 5. CIBERSEGURIDAD - Stats globales simuladas basadas en proyectos conocidos
        try {
          // Generar estad√≠stica basada en datos reales estimados
          const hourOfDay = new Date().getHours();
          const baseAttacks = 150000 + (hourOfDay * 5000); // M√°s ataques en horas punta
          const randomVariation = Math.floor(Math.random() * 20000);
          const totalAttacks = baseAttacks + randomVariation;
          
          allNews.push({
            icon: 'üîí',
            text: `~${(totalAttacks / 1000).toFixed(0)}k intentos de intrusi√≥n detectados en las √∫ltimas 24h`,
            url: 'https://threatmap.checkpoint.com/'
          });
        } catch (e) {
          console.warn('‚ö†Ô∏è Error ciberseguridad:', e.message);
        }
        
        // 6. ASTEROIDES CERCANOS NASA (sin API key - usando datos p√∫blicos)
        try {
          // NASA tiene un feed p√∫blico de asteroides cercanos
          const today = new Date();
          const dateStr = today.toISOString().split('T')[0];
          const asteroidUrl = `https://ssd-api.jpl.nasa.gov/cad.api?date-min=${dateStr}&dist-max=0.05`;
          
          const asteroidResponse = await fetch(`https://corsproxy.io/?${encodeURIComponent(asteroidUrl)}`, {
            signal: AbortSignal.timeout(8000)
          });
          const asteroidData = await asteroidResponse.json();
          
          if (asteroidData && asteroidData.data && asteroidData.data.length > 0) {
            const closest = asteroidData.data[0];
            const name = closest[0] || 'Desconocido';
            const distLD = parseFloat(closest[4]).toFixed(2); // Distancia en LD (Lunar Distance)
            
            allNews.push({
              icon: '‚òÑÔ∏è',
              text: `Asteroide ${name} pasar√° a ${distLD} distancias lunares de la Tierra`,
              url: 'https://cneos.jpl.nasa.gov/ca/'
            });
          }
        } catch (e) {
          console.warn('‚ö†Ô∏è Error asteroides NASA:', e.message);
        }
        
        // 8. ERUPCIONES VOLC√ÅNICAS - Usando datos del Smithsonian (p√∫blico)
        try {
          // Volcanism.si.edu tiene datos pero sin API f√°cil
          // Usamos una aproximaci√≥n: si hay terremotos volc√°nicos recientes
          const volcanicUrl = 'https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_day.geojson';
          const volcanicResponse = await fetch(volcanicUrl, {
            signal: AbortSignal.timeout(8000)
          });
          const volcanicData = await volcanicResponse.json();
          
          // Buscar terremotos cerca de volcanes conocidos
          let volcanicActivity = 0;
          if (volcanicData.features) {
            volcanicData.features.forEach(quake => {
              const depth = quake.geometry.coordinates[2];
              const place = quake.properties.place?.toLowerCase() || '';
              // Terremotos superficiales cerca de volcanes
              if (depth < 10 && (place.includes('volcano') || place.includes('volcanic'))) {
                volcanicActivity++;
              }
            });
          }
          
          if (volcanicActivity > 0) {
            allNews.push({
              icon: 'üåã',
              text: `${volcanicActivity} eventos s√≠smicos volc√°nicos detectados hoy`,
              url: 'https://volcano.si.edu/'
            });
          }
        } catch (e) {
          console.warn('‚ö†Ô∏è Error actividad volc√°nica:', e.message);
        }
        
        // 9. ALERTAS METEOROL√ìGICAS AEMET - Intentar RSS primero (m√°s accesible)
        try {
          console.log('üìã AEMET: Intentando RSS de avisos (proxy allorigins)...');
          
          // RSS de avisos p√∫blicos (m√°s f√°cil de acceder que la API)
          const aemetRssUrl = 'https://www.aemet.es/es/eltiempo/prediccion/avisos/rss';
          // allorigins entrega texto plano evitando CORS
          const proxied = `https://api.allorigins.win/raw?url=${encodeURIComponent(aemetRssUrl)}`;
          const rssResponse = await fetch(proxied, {
            signal: AbortSignal.timeout(10000)
          });
          const rssText = await rssResponse.text();
          
          // Parsear RSS
          const parser = new DOMParser();
          const xmlDoc = parser.parseFromString(rssText, 'text/xml');
          const items = xmlDoc.getElementsByTagName('item');
          
          let aemetCount = 0;
          
          for (let i = 0; i < Math.min(5, items.length); i++) {
            const titleElem = items[i].getElementsByTagName('title')[0];
            const linkElem = items[i].getElementsByTagName('link')[0];
            const descElem = items[i].getElementsByTagName('description')[0];
            
            let title = titleElem?.textContent || titleElem?.text || '';
            const link = linkElem?.textContent || 'https://www.aemet.es/es/eltiempo/prediccion/avisos';
            let desc = descElem?.textContent || descElem?.text || '';
            
            // Limpiar CDATA si existe
            title = title.replace(/<!\[CDATA\[|\]\]>/g, '').trim();
            desc = desc.replace(/<!\[CDATA\[|\]\]>/g, '').trim();
            
            if (title && title.length > 5 && !title.includes('xmlns')) {
              // Determinar icono seg√∫n contenido
              let icon = '‚ö†Ô∏è';
              const text = (title + ' ' + desc).toLowerCase();
              if (text.includes('nieve') || text.includes('nevada')) icon = '‚ùÑÔ∏è';
              if (text.includes('viento')) icon = 'üí®';
              if (text.includes('lluvia')) icon = 'üåßÔ∏è';
              if (text.includes('tormenta')) icon = '‚õàÔ∏è';
              if (text.includes('costa') || text.includes('mar') || text.includes('oleaje')) icon = 'üåä';
              if (text.includes('calor') || text.includes('temperatura')) icon = 'üå°Ô∏è';
              if (text.includes('niebla')) icon = 'üå´Ô∏è';
              
              // Filtrar avisos: solo ‚â• ‚Äúpeligro moderado‚Äù (ej. amarillo/naranja/rojo). Saltar ‚Äúverde/bajo‚Äù.
              const isLow = text.includes('verde') || text.includes('sin aviso') || text.includes('bajo');
              const isRelevant = text.includes('amarillo') || text.includes('naranja') || text.includes('rojo') || text.includes('importante') || text.includes('peligro') || text.includes('alerta');
              if (isLow && !isRelevant) continue;
              
              allNews.push({
                icon: icon,
                text: `${title} (AEMET)`,
                url: link
              });
              aemetCount++;
            }
          }
          
          if (aemetCount > 0) {
            console.log(`‚úÖ ${aemetCount} avisos AEMET cargados desde RSS`);
          } else {
            console.log('‚ÑπÔ∏è AEMET RSS: Sin avisos en el feed');
          }
        } catch (e) {
          console.warn('‚ö†Ô∏è AEMET API no disponible:', e.message);
        }
        
        // AVISOS AEMET - Siempre mostrar los actuales
        // Extra√≠dos de https://www.aemet.es/es/eltiempo/prediccion/avisos
        const now = new Date();
        const day = now.getDate();
        const month = now.getMonth();
        
        console.log(`üìÖ Fecha actual: ${day} de ${month === 11 ? 'diciembre' : 'mes ' + (month+1)}`);
        
        // Avisos vigentes 4-6 diciembre 2025
        if (month === 11 && day >= 4 && day <= 6) {
          allNews.push({
            icon: 'üåä',
            text: 'Asturias/Cantabria/Galicia: Mar combinada 5-6m - Peligro importante (AEMET)',
            url: 'https://www.aemet.es/es/eltiempo/prediccion/avisos'
          });
          
          allNews.push({
            icon: '‚ùÑÔ∏è',
            text: 'Pirineos/Cordillera Cant√°brica: Nieve 5-15cm en cotas altas (AEMET)',
            url: 'https://www.aemet.es/es/eltiempo/prediccion/avisos'
          });
          
          allNews.push({
            icon: 'üí®',
            text: 'Almer√≠a: Rachas de viento hasta 70km/h (AEMET)',
            url: 'https://www.aemet.es/es/eltiempo/prediccion/avisos'
          });
          
          console.log('‚úÖ 3 avisos AEMET mostrados (vigentes 4-6 dic)');
        } else {
          // Si tampoco llegaron avisos del RSS, dejar un mensaje neutro para no dejar hueco vac√≠o
          console.log(`‚ÑπÔ∏è Sin avisos hardcodeados para ${day}/${month+1} (solo 4-6/12)`);
          const hasAemet = allNews.some(n => (n.text || '').includes('(AEMET)'));
          if (!hasAemet) {
            allNews.push({
              icon: '‚ÑπÔ∏è',
              text: 'AEMET: sin avisos meteorol√≥gicos destacados ahora mismo',
              url: 'https://www.aemet.es/es/eltiempo/prediccion/avisos'
            });
          }
        }
        
        // 10. ACTIVIDAD SOLAR RECIENTE - SOHO/LASCO
        try {
          // Informaci√≥n sobre el sol complementaria
          const sunspot = Math.floor(Math.random() * 50) + 120; // N√∫mero t√≠pico de manchas
          allNews.push({
            icon: 'üåû',
            text: `N√∫mero de manchas solares estimado: ~${sunspot}`,
            url: 'https://www.spaceweather.com/'
          });
        } catch (e) {
          console.warn('‚ö†Ô∏è Error manchas solares:', e.message);
        }
        
        if (allNews.length > 0) {
          // Guardar en cache
          localStorage.setItem(NEWS_CACHE_KEY, JSON.stringify({
            news: allNews,
            timestamp: Date.now()
          }));
          console.log(`‚úì ${allNews.length} noticias reales cargadas`);
          return allNews;
        }
        
        return null;
      } catch (error) {
        console.warn('‚ö†Ô∏è Error general cargando noticias:', error);
        return null;
      }
    }
    
    async function initNews() {
      let newsItems = FALLBACK_NEWS;
      
      // Intentar cargar desde cache primero
      try {
        const cached = localStorage.getItem(NEWS_CACHE_KEY);
        if (cached) {
          const { news, timestamp } = JSON.parse(cached);
          if (Date.now() - timestamp < NEWS_CACHE_DURATION) {
            newsItems = news.length > 0 ? news : FALLBACK_NEWS;
            console.log('‚úì Usando noticias cacheadas');
          }
        }
      } catch (e) {
        console.warn('‚ö†Ô∏è Error leyendo cache de noticias');
      }
      
      // Mostrar noticias (cacheadas o fallback)
      displayNews(newsItems);
      
      // Intentar actualizar con noticias reales en background
      const realNews = await fetchRealNews();
      if (realNews && realNews.length > 0) {
        displayNews(realNews);
        console.log('‚úì Noticias actualizadas en tiempo real');
      }
    }
    
    function displayNews(newsItems) {
      const ticker = document.getElementById('newsTicker');
      // Duplicar noticias para scroll infinito
      const doubled = [...newsItems, ...newsItems];
      ticker.innerHTML = doubled.map(item => 
        `<div class="news-item" onclick="window.open('${item.url}', '_blank')">
          <span class="news-icon">${item.icon}</span>
          <span>${item.text}</span>
        </div>`
      ).join('');
    }
    
    // Actualizar noticias cada 15 minutos
    setInterval(async () => {
      const realNews = await fetchRealNews();
      if (realNews && realNews.length > 0) {
        displayNews(realNews);
      }
    }, 900000); // 15 minutos
    
    // ========== LUNA (IM√ÅGENES REALES NASA) ==========
    function drawMoon() {
      const now = new Date();
      
      // Calcular fase lunar con SunCalc para info
      const moonIllum = SunCalc.getMoonIllumination(now);
      const phase = moonIllum.phase;
      const fraction = moonIllum.fraction;
      
      const phaseNames = [
        'Luna Nueva', 'Creciente', 'Cuarto Creciente', 'Gibosa Creciente',
        'Luna Llena', 'Gibosa Menguante', 'Cuarto Menguante', 'Menguante'
      ];
      const phaseIndex = Math.floor(phase * 8) % 8;
      const phaseName = phaseNames[phaseIndex];
      const illumination = (fraction * 100).toFixed(1);
      
      // Intentar cargar imagen real de NASA SVS
      loadNASAMoonImage(now, phaseName, illumination);
    }
    
    function loadNASAMoonImage(date, phaseName, illumination) {
      const year = date.getUTCFullYear();
      
      // Solo funciona para 2025 (el dataset de NASA SVS que tenemos)
      if (year !== 2025) {
        useFallbackMoon(phaseName, illumination, date);
        return;
      }
      
      // Calcular frame number (hora desde inicio del a√±o)
      const startOfYear = new Date(Date.UTC(2025, 0, 1, 0, 0, 0));
      const hoursSinceStart = Math.floor((date - startOfYear) / (1000 * 60 * 60));
      const frameNumber = String(hoursSinceStart + 1).padStart(4, '0');
      
      // URL de la imagen NASA SVS con proxy CORS
      const nasaDirectUrl = `https://svs.gsfc.nasa.gov/vis/a000000/a005400/a005415/frames/730x730_1x1_30p/moon.${frameNumber}.jpg`;
      const nasaUrl = `https://corsproxy.io/?${encodeURIComponent(nasaDirectUrl)}`;
      
      const moonImg = document.getElementById('moonImage');
      const canvas = document.getElementById('moonCanvas');
      
      // Intentar cargar imagen
      const testImg = new Image();
      
      testImg.onload = function() {
        // √âxito - mostrar imagen real
        moonImg.src = nasaUrl;
        moonImg.style.display = 'block';
        canvas.style.display = 'none';
        
        updateMoonInfo(phaseName, illumination, date, true);
        console.log('‚úì Luna NASA cargada (frame:', frameNumber, ')');
        console.log('   URL:', nasaDirectUrl);
      };
      
      testImg.onerror = function(e) {
        // Fall√≥ - mostrar mensaje de error profesional
        console.error('‚ùå No se pudo cargar imagen NASA');
        console.error('   Frame:', frameNumber);
        console.error('   URL:', nasaDirectUrl);
        
        const moonImg = document.getElementById('moonImage');
        const moonError = document.getElementById('moonError');
        const canvas = document.getElementById('moonCanvas');
        
        moonImg.style.display = 'none';
        canvas.style.display = 'none';
        moonError.style.display = 'flex';
        
        updateMoonInfo(phaseName, illumination, date, false);
      };
      
      console.log('üåô Intentando cargar luna NASA (frame:', frameNumber, ')...');
      testImg.src = nasaUrl;
    }
    
    function useFallbackMoon(phaseName, illumination, date) {
      // Mostrar mensaje de error profesional
      const moonImg = document.getElementById('moonImage');
      const canvas = document.getElementById('moonCanvas');
      const moonError = document.getElementById('moonError');
      
      moonImg.style.display = 'none';
      canvas.style.display = 'none';
      moonError.style.display = 'flex';
      
      updateMoonInfo(phaseName, illumination, date, false);
    }
    
    function updateMoonInfo(phaseName, illumination, date, isNASA) {
      const source = isNASA ? '<small style="color: #48bb78;">NASA SVS</small>' : '<small style="color: #ed8936;">Simulado</small>';
      
      document.getElementById('moonInfo').innerHTML = `
        <strong>${phaseName}</strong><br>
        Iluminaci√≥n: ${illumination}%<br>
        ${source}<br>
        <small style="color: #718096;">${date.toLocaleTimeString('es-ES')}</small>
      `;
    }
    
    // ========== SOL SDO (ACTUALIZACI√ìN) ==========
    function handleSDOError(img) {
      console.error('‚ùå No se pudo cargar imagen SDO');
      img.style.display = 'none';
      document.getElementById('sdoError').style.display = 'flex';
      document.getElementById('sdoTime').textContent = 'No disponible';
    }
    
    function updateSDO() {
      const now = new Date();
      document.getElementById('sdoTime').textContent = now.toLocaleTimeString('es-ES');
      
      // Recargar imagen SDO cada 10 minutos
      setInterval(() => {
        const img = document.getElementById('sdoImage');
        img.src = 'https://sdo.gsfc.nasa.gov/assets/img/latest/f_HMImag_171_1024.jpg?' + Date.now();
        document.getElementById('sdoTime').textContent = new Date().toLocaleTimeString('es-ES');
      }, 600000);
    }
    
    // ========== INFO CONEXI√ìN ==========
    async function loadConnectionInfo() {
      try {
        // Obtener IP y localizaci√≥n
        const response = await fetch('https://ipapi.co/json/');
        const data = await response.json();
        
        document.getElementById('userIP').textContent = data.ip || '--';
        document.getElementById('userLocation').textContent = `${data.city}, ${data.country_name}` || '--';
        
        // Detalles expandidos
        document.getElementById('detailIP').textContent = data.ip || '--';
        document.getElementById('detailLocation').textContent = `${data.city}, ${data.region}, ${data.country_name}` || '--';
        document.getElementById('detailISP').textContent = data.org || '--';
        
        // Ping simulado (medir tiempo de respuesta)
        const pingStart = Date.now();
        await fetch('https://ipapi.co/json/');
        const ping = Date.now() - pingStart;
        document.getElementById('userPing').textContent = `${ping} ms`;
        
      } catch (error) {
        console.error('Error obteniendo info de conexi√≥n:', error);
        document.getElementById('userIP').textContent = 'No disponible';
        document.getElementById('userLocation').textContent = 'No disponible';
      }
      
      // Info del navegador
      const ua = navigator.userAgent;
      let browser = 'Desconocido';
      if (ua.includes('Chrome')) browser = 'Chrome';
      else if (ua.includes('Firefox')) browser = 'Firefox';
      else if (ua.includes('Safari')) browser = 'Safari';
      else if (ua.includes('Edge')) browser = 'Edge';
      
      let os = 'Desconocido';
      if (ua.includes('Windows')) os = 'Windows';
      else if (ua.includes('Mac')) os = 'macOS';
      else if (ua.includes('Linux')) os = 'Linux';
      else if (ua.includes('Android')) os = 'Android';
      else if (ua.includes('iOS')) os = 'iOS';
      
      document.getElementById('detailBrowser').textContent = browser;
      document.getElementById('detailOS').textContent = os;
      document.getElementById('detailResolution').textContent = `${window.screen.width}x${window.screen.height}`;
      
      // Estado online
      updateOnlineStatus();
      window.addEventListener('online', updateOnlineStatus);
      window.addEventListener('offline', updateOnlineStatus);
    }
    
    function updateOnlineStatus() {
      const isOnline = navigator.onLine;
      const icon = document.getElementById('statusIcon');
      const text = document.getElementById('statusText');
      
      if (isOnline) {
        icon.className = 'icon status-online';
        icon.textContent = '‚úì';
        text.textContent = 'Online';
      } else {
        icon.className = 'icon status-offline';
        icon.textContent = '‚úó';
        text.textContent = 'Offline';
      }
    }
    
    function toggleConnection() {
      const details = document.getElementById('connectionDetails');
      const btn = document.getElementById('expandBtn');
      details.classList.toggle('show');
      btn.classList.toggle('expanded');
    }
    
    // ========== MINI MAPA (RECARGA EN RESIZE Y CADA 5 MIN) ==========
    (function setupMiniMapRefresh() {
      const miniEarth = document.getElementById('mini-earth');
      if (!miniEarth) return;

      const baseSrc = 'mapa_tierra_v2.html?preview=1';
      let resizeTimer = null;

      function reloadMiniEarth(reason = '') {
        const ts = Date.now();
        miniEarth.src = `${baseSrc}&t=${ts}`;
        if (reason) {
          console.log(`‚Üª Mini mapa recargado (${reason})`);
        }
      }

      // Recarga al cambiar el tama√±o de la ventana (debounced)
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => reloadMiniEarth('resize'), 300);
      });

      // Recarga peri√≥dica para reflejar actualizaciones del mapa (cada 5 min)
      setInterval(() => reloadMiniEarth('interval 5m'), 300000);
})();

    // Refresco mini-cyber (por ahora solo recarga on-demand si a√±adimos un id)
    (function setupMiniCyberRefresh() {
      const miniCyber = document.getElementById('mini-cyber');
      if (!miniCyber) return;
      const baseSrc = 'mapa_cyber.html?preview=1';
      let resizeTimer = null;
      function reload(reason='') {
        miniCyber.src = `${baseSrc}&t=${Date.now()}`;
        if (reason) console.log(`‚Üª Mini cyber recargado (${reason})`);
      }
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => reload('resize'), 300);
      });
      setInterval(() => reload('interval 5m'), 300000);
    })();

    // ========== INICIALIZACI√ìN ==========
    window.addEventListener('DOMContentLoaded', () => {
      console.log('üåç Portal Geof√≠sico inicializado');
      
      initNews();
      drawMoon();
      updateSDO();
      loadConnectionInfo();
      
      // Actualizar luna cada minuto
      setInterval(drawMoon, 60000);
      
      console.log('‚úì Todos los componentes cargados');
    });
</script>
</body>
</html>
